name: pull_request

on:
  pull_request:
    branches: [ "develop" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.BE_DISCORD_WEB_HOOK }}
    steps:
      - name: Extract receiver list
        id: extract_receiver_list
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const excludeMember = context.payload.pull_request.user.login;
            const decoded = Buffer.from(`${{ secrets.BE_MEMBER_JSON }}`, 'base64').toString('utf-8');
            const members = JSON.parse(decoded);

            const requester = members.find(entry => entry.github === excludeMember);
            let outputString = '';
            for (const member of members) {
              if ((member.github !== excludeMember)) {
                outputString += `<@${member.discord}> `;
              }
            }
            core.setOutput("names", outputString.trim());
            core.setOutput("requester", requester?.github || excludeMember);

      - name: Discord Message
        uses: discord-actions/message@v2
        with:
          webhookUrl: ${{ env.DISCORD_WEBHOOK_URL }}
          message: |
            ${{steps.extract_receiver_list.outputs.requester}} PR이 도착했습니다. 
            ↓↓↓
            
            *[${{github.event.pull_request.title}}](${{github.event.pull_request.html_url}})* 

            _리뷰할 사람: ${{steps.extract_receiver_list.outputs.names}}_
